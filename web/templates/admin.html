<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –õ–µ–æ</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/main.css" />
  <style>
    body { font-family: Roboto, sans-serif; margin: 0; background: #f5f5f5; }
    header {
      display: flex; align-items: center; padding: 15px; background: white; border-bottom: 1px solid #ddd;
      position: sticky; top: 0; z-index: 100;
    }
    .back-btn {
      background: none; border: 1px solid #ddd; padding: 8px 16px; border-radius: 8px;
      color: #4CAF50; cursor: pointer; font-size: 14px; font-family: inherit;
    }
    .back-btn:hover { background: #4CAF50; color: white; border-color: #4CAF50; }
    .title { font-size: 18px; font-weight: 500; margin: 0 15px; }
    .admin-badge { margin-left: auto; background: #8E24AA; color: white; padding: 6px 12px; border-radius: 12px; }
    main { padding: 20px; max-width: 1200px; margin: 0 auto; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .btn {
      padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;
    }
    .btn.primary { background: #4CAF50; color: white; }
    .text-danger { color: #D32F2F; }
    #stats-container canvas { max-width: 80%; height: 300px !important; margin: 20px auto; display: block; }
  </style>
</head>
<body>

  <div class="screen active">
    <header>
      <button class="back-btn" type="button" onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>
      <div class="title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
      <span class="admin-badge">üëë –ê–¥–º–∏–Ω</span>
    </header>

    <main>
      <div style="margin-bottom: 20px; text-align: right;">
        <label><strong>–†–µ–∂–∏–º:</strong></label>
        <select id="view-mode" onchange="changeViewMode(this.value)">
          <option value="cards">–ö–∞—Ä—Ç–æ—á–∫–∏</option>
          <option value="table">–¢–∞–±–ª–∏—Ü–∞</option>
          <option value="chart">–ì—Ä–∞—Ñ–∏–∫</option>
          <option value="bars">–°—Ç–æ–ª–±—Ü—ã</option>
        </select>
      </div>

      <div id="stats-container">
        <div class="card">
          <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
          <p><strong>–í—Å–µ–≥–æ:</strong> <span id="total-users">‚Äì</span></p>
          <p><strong>–ü—Ä–µ–º–∏—É–º:</strong> <span id="premium-users">‚Äì</span></p>
          <p><strong>–°–µ–≥–æ–¥–Ω—è:</strong> <span id="active-today">‚Äì</span></p>
          <p><strong>–†–µ—Ñ–µ—Ä–∞–ª–æ–≤:</strong> <span id="referrals-count">‚Äì</span></p>
        </div>
      </div>

      <div class="card" style="margin-top: 20px;">
        <h3>üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
        <input type="text" id="search-user" placeholder="ID –∏–ª–∏ @username" style="width: 70%; padding: 10px; margin-right: 10px;">
        <button class="btn primary" onclick="searchUser()">–ü–æ–∏—Å–∫</button>
        <div id="user-actions" style="display: none; margin-top: 15px;">
          <p><strong>–ù–∞–π–¥–µ–Ω:</strong> <span id="found-user"></span></p>
          <button class="btn" style="background: #4CAF50;" onclick="grantPremium()">‚úÖ –í—ã–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º</button>
          <button class="btn" style="background: #FF9800;" onclick="revokePremium()">üö´ –°–Ω—è—Ç—å</button>
          <button class="btn" style="background: #F44336;" onclick="blockUser()">‚õî –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    let statsData = {};
    let currentChart = null;

    document.addEventListener('DOMContentLoaded', async () => {
      await loadStats();
      changeViewMode('cards');
    });

    async function loadStats() {
      try {
        const res = await fetch('/api/admin/stats');
        statsData = await res.json();
        renderStatsCards();
      } catch (e) {
        document.getElementById('stats-container').innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
        console.error(e);
      }
    }

    function changeViewMode(mode) {
      if (currentChart) { currentChart.destroy(); currentChart = null; }
      const container = document.getElementById('stats-container');

      if (mode === 'cards') renderStatsCards();
      else if (mode === 'table') renderStatsTable();
      else if (mode === 'chart') renderActivityChart();
      else if (mode === 'bars') renderCommandsChart();
    }

    function renderStatsCards() {
      document.getElementById('stats-container').innerHTML = `
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px; background: #1976D2; color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <h4>${statsData.total_users || 0}</h4>
            <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
          </div>
          <div style="flex: 1; min-width: 200px; background: #388E3C; color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <h4>${statsData.premium_users || 0}</h4>
            <p>–ü—Ä–µ–º–∏—É–º</p>
          </div>
          <div style="flex: 1; min-width: 200px; background: #1976D2; color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <h4>${statsData.active_today || 0}</h4>
            <p>–ê–∫—Ç–∏–≤–Ω–æ —Å–µ–≥–æ–¥–Ω—è</p>
          </div>
          <div style="flex: 1; min-width: 200px; background: #FF8F00; color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <h4>${statsData.referrals_count || 0}</h4>
            <p>–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</p>
          </div>
        </div>`;
    }

    function renderStatsTable() {
      document.getElementById('stats-container').innerHTML = `
        <table class="card" style="width: 100%; border-collapse: collapse;">
          <tr><td style="padding: 10px; border: 1px solid #ddd;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</td><td style="padding: 10px; border: 1px solid #ddd;">${statsData.total_users || 0}</td></tr>
          <tr><td style="padding: 10px; border: 1px solid #ddd;">–ü—Ä–µ–º–∏—É–º</td><td style="padding: 10px; border: 1px solid #ddd;">${statsData.premium_users || 0}</td></tr>
          <tr><td style="padding: 10px; border: 1px solid #ddd;">–ê–∫—Ç–∏–≤–Ω–æ —Å–µ–≥–æ–¥–Ω—è</td><td style="padding: 10px; border: 1px solid #ddd;">${statsData.active_today || 0}</td></tr>
          <tr><td style="padding: 10px; border: 1px solid #ddd;">–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</td><td style="padding: 10px; border: 1px solid #ddd;">${statsData.referrals_count || 0}</td></tr>
        </table>`;
    }

    function renderActivityChart() {
      document.getElementById('stats-container').innerHTML = '<canvas id="chart"></canvas>';
      fetch('/api/admin/activity-by-day').then(r => r.json()).then(data => {
        const ctx = document.getElementById('chart').getContext('2d');
        currentChart = new Chart(ctx, {
          type: 'line',
          data: { labels: data.dates, datasets: [{ label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', data: data.counts, borderColor: '#4CAF50', tension: 0.3 }] },
          options: { responsive: true }
        });
      });
    }

    function renderCommandsChart() {
      document.getElementById('stats-container').innerHTML = '<canvas id="chart"></canvas>';
      fetch('/api/admin/top-commands').then(r => r.json()).then(data => {
        const ctx = document.getElementById('chart').getContext('2d');
        currentChart = new Chart(ctx, {
          type: 'bar',
          data: { labels: data.commands, datasets: [{ label: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ', data: data.counts, backgroundColor: '#66BB6A' }] },
          options: { responsive: true, indexAxis: 'y' }
        });
      });
    }

    async function searchUser() {
      const q = document.getElementById('search-user').value.trim();
      if (!q) return;
      const res = await fetch(`/api/admin/user?query=${encodeURIComponent(q)}`);
      const user = await res.json();
      if (user) {
        document.getElementById('found-user').textContent = `@${user.username} (ID: ${user.id})`;
        document.getElementById('user-actions').style.display = 'block';
        window.user = user;
      } else {
        alert('–ù–µ –Ω–∞–π–¥–µ–Ω');
      }
    }

    async function grantPremium() {
      if (!window.user) return;
      await fetch('/api/admin/grant-premium', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: window.user.id })
      });
      alert('‚úÖ –í—ã–¥–∞–Ω–æ');
    }

    async function revokePremium() {
      if (!window.user) return;
      await fetch('/api/admin/revoke-premium', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: window.user.id })
      });
      alert('‚úÖ –°–Ω—è—Ç–æ');
    }

    async function blockUser() {
      if (!window.user) return;
      await fetch('/api/admin/block-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: window.user.id })
      });
      alert('‚úÖ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>