<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –õ–µ–æ</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/main.css" />
  <style>
    body { font-family: Roboto, sans-serif; margin: 0; background: #f5f5f5; }
    header {
      display: flex; align-items: center; padding: 15px; background: white; border-bottom: 1px solid #ddd;
      position: sticky; top: 0; z-index: 100;
    }
    .back-btn {
      background: none; border: 1px solid #ddd; padding: 8px 16px; border-radius: 8px;
      color: #4CAF50; cursor: pointer; font-size: 14px; font-family: inherit;
    }
    .back-btn:hover { background: #4CAF50; color: white; border-color: #4CAF50; }
    .title { font-size: 18px; font-weight: 500; margin: 0 15px; }
    .admin-badge { margin-left: auto; background: #8E24AA; color: white; padding: 6px 12px; border-radius: 12px; }
    main { padding: 20px; max-width: 1200px; margin: 0 auto; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .btn {
      padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;
    }
    .btn.primary { background: #4CAF50; color: white; }
    .text-danger { color: #D32F2F; }
    #stats-container canvas {
      max-width: 80%;
      height: 300px !important;
      margin: 20px auto;
      display: block;
    }
    .section { margin-top: 20px; }
  </style>
</head>
<body>

  <div class="screen active">
    <header>
      <button class="back-btn" type="button" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
      <div class="title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
      <span class="admin-badge">üëë –ê–¥–º–∏–Ω</span>
    </header>

    <main>
      <!-- –†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
      <div style="margin-bottom: 20px; text-align: right;">
        <label><strong>–†–µ–∂–∏–º:</strong></label>
        <select id="view-mode" onchange="changeViewMode(this.value)">
          <option value="cards">–ö–∞—Ä—Ç–æ—á–∫–∏</option>
          <option value="table">–¢–∞–±–ª–∏—Ü–∞</option>
          <option value="chart">–ì—Ä–∞—Ñ–∏–∫</option>
          <option value="bars">–°—Ç–æ–ª–±—Ü—ã</option>
        </select>
      </div>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div id="stats-container">
        <div class="card">
          <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
          <p><strong>–í—Å–µ–≥–æ:</strong> <span id="total-users">‚Äì</span></p>
          <p><strong>–ü—Ä–µ–º–∏—É–º:</strong> <span id="premium-users">‚Äì</span></p>
          <p><strong>–°–µ–≥–æ–¥–Ω—è:</strong> <span id="active-today">‚Äì</span></p>
          <p><strong>–†–µ—Ñ–µ—Ä–∞–ª–æ–≤:</strong> <span id="referrals-count">‚Äì</span></p>
        </div>
      </div>

      <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
      <div class="card section">
        <h3>üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
        <input type="text" id="search-user" placeholder="ID –∏–ª–∏ @username" style="width: 70%; padding: 10px; margin-right: 10px;">
        <button class="btn primary" onclick="searchUser()">–ü–æ–∏—Å–∫</button>
        <div id="user-actions" style="display: none; margin-top: 15px;">
          <p><strong>–ù–∞–π–¥–µ–Ω:</strong> <span id="found-user"></span></p>
          <button class="btn" style="background: #4CAF50;" onclick="grantPremium()">‚úÖ –í—ã–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º</button>
          <button class="btn" style="background: #FF9800;" onclick="revokePremium()">üö´ –°–Ω—è—Ç—å</button>
          <button class="btn" style="background: #F44336;" onclick="blockUser()">‚õî –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>

      <!-- –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤ -->
      <div class="card section">
        <h3>üìù –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤</h3>
        <div id="reviews-list" style="max-height: 300px; overflow-y: auto;">
          <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
      </div>

      <!-- –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞ -->
      <div class="card section">
        <h3>üì¨ –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞</h3>
        <div id="support-list" style="max-height: 300px; overflow-y: auto;">
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π...</p>
        </div>
      </div>

      <!-- –†–µ–∫–ª–∞–º–∞ -->
      <div class="card section">
        <h3>üì¢ –†–µ–∫–ª–∞–º–∞</h3>
        <div id="ads-list" style="margin-top: 15px;">
          <p>üõ† –§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
        </div>
      </div>
    </main>
  </div>

  <!-- üî• –í–ê–ñ–ù–û: Chart.js ‚Äî –î–û –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    let statsData = {};
    let currentChart = null;

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('‚úÖ DOM –∑–∞–≥—Ä—É–∂–µ–Ω');
      await loadStats();
      await loadReviews();
      await loadSupportTickets();
      changeViewMode('cards');
    });

    async function loadStats() {
      try {
        const res = await fetch('/api/admin/stats');
        statsData = await res.json();
        renderStatsCards();
      } catch (e) {
        document.getElementById('stats-container').innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', e);
      }
    }

    function changeViewMode(mode) {
      if (currentChart) {
        currentChart.destroy();
        currentChart = null;
      }

      if (mode === 'cards') renderStatsCards();
      else if (mode === 'table') renderStatsTable();
      else if (mode === 'chart') renderActivityChart();
      else if (mode === 'bars') renderCommandsChart();
    }

    function renderStatsCards() {
      document.getElementById('stats-container').innerHTML = `
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px; background: #1976D2; color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <h4>${statsData.total_users || 0}</h4>
            <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
          </div>
          <div style="flex: 1; min-width: 200px; background: #388E3C; color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <h4>${statsData.premium_users || 0}</h4>
            <p>–ü—Ä–µ–º–∏—É–º</p>
          </div>
          <div style="flex: 1; min-width: 200px; background: #1976D2; color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <h4>${statsData.active_today || 0}</h4>
            <p>–ê–∫—Ç–∏–≤–Ω–æ —Å–µ–≥–æ–¥–Ω—è</p>
          </div>
          <div style="flex: 1; min-width: 200px; background: #FF8F00; color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <h4>${statsData.referrals_count || 0}</h4>
            <p>–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</p>
          </div>
        </div>`;
    }

    function renderStatsTable() {
      document.getElementById('stats-container').innerHTML = `
        <table class="card" style="width: 100%; border-collapse: collapse;">
          <tr><td>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</td><td>${statsData.total_users || 0}</td></tr>
          <tr><td>–ü—Ä–µ–º–∏—É–º</td><td>${statsData.premium_users || 0}</td></tr>
          <tr><td>–ê–∫—Ç–∏–≤–Ω–æ —Å–µ–≥–æ–¥–Ω—è</td><td>${statsData.active_today || 0}</td></tr>
          <tr><td>–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</td><td>${statsData.referrals_count || 0}</td></tr>
        </table>`;
    }

    function renderActivityChart() {
      // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫
      if (currentChart) {
        currentChart.destroy();
        currentChart = null;
      }

      // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º canvas —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º id
      const container = document.getElementById('stats-container');
      container.innerHTML = '<div style="text-align: center;"><canvas id="activityChart" height="300"></canvas></div>';

      // –î–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ DOM
      setTimeout(() => {
        try {
          const ctx = document.getElementById('activityChart').getContext('2d');
          fetch('/api/admin/activity-by-day')
            .then(res => res.json())
            .then(data => {
              currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: data.dates,
                  datasets: [{
                    label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º',
                    data: data.counts,
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    fill: true,
                    tension: 0.3
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { display: true }
                  }
                }
              });
            })
            .catch(err => {
              container.innerHTML = '<p class="text-danger">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫</p>';
              console.error('‚ùå –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞:', err);
            });
        } catch (err) {
          container.innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞</p>';
          console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞:', err);
        }
      }, 100); // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ —Ä–µ–Ω–¥–µ—Ä
    }

    function renderCommandsChart() {
      // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫
      if (currentChart) {
        currentChart.destroy();
        currentChart = null;
      }

      // –û—á–∏—â–∞–µ–º –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π canvas
      const container = document.getElementById('stats-container');
      container.innerHTML = '<div style="text-align: center;"><canvas id="commandsChart" height="300"></canvas></div>';

      // –î–∞—ë–º –≤—Ä–µ–º—è
      setTimeout(() => {
        try {
          const ctx = document.getElementById('commandsChart').getContext('2d');
          fetch('/api/admin/top-commands')
            .then(res => res.json())
            .then(data => {
              currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: data.commands,
                  datasets: [{
                    label: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ',
                    data: data.counts,
                    backgroundColor: '#66BB6A'
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  indexAxis: 'y',
                  plugins: {
                    legend: { display: true }
                  }
                }
              });
            })
            .catch(err => {
              container.innerHTML = '<p class="text-danger">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É</p>';
              console.error('‚ùå –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤:', err);
            });
        } catch (err) {
          container.innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞</p>';
          console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã:', err);
        }
      }, 100);
    }

    async function searchUser() {
      const q = document.getElementById('search-user').value.trim();
      if (!q) return;
      try {
        const res = await fetch(`/api/admin/user?query=${encodeURIComponent(q)}`);
        const user = await res.json();
        if (user) {
          document.getElementById('found-user').textContent = `@${user.username} (ID: ${user.id})`;
          document.getElementById('user-actions').style.display = 'block';
          window.user = user;
        } else {
          alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
        console.error(e);
      }
    }

    async function grantPremium() {
      if (!window.user) return;
      if (!confirm(`–í—ã–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º @${window.user.username}?`)) return;
      try {
        await fetch('/api/admin/grant-premium', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: window.user.id })
        });
        alert('‚úÖ –ü—Ä–µ–º–∏—É–º –≤—ã–¥–∞–Ω –Ω–∞ 30 –¥–Ω–µ–π');
      } catch (e) {
        alert('‚ùå –û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏');
      }
    }

    async function revokePremium() {
      if (!window.user) return;
      if (!confirm(`–°–Ω—è—Ç—å –ø—Ä–µ–º–∏—É–º —É @${window.user.username}?`)) return;
      try {
        await fetch('/api/admin/revoke-premium', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: window.user.id })
        });
        alert('‚úÖ –ü—Ä–µ–º–∏—É–º —Å–Ω—è—Ç');
      } catch (e) {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–Ω—è—Ç–∏—è');
      }
    }

    async function blockUser() {
      if (!window.user) return;
      if (!confirm(`–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å @${window.user.username}?`)) return;
      try {
        await fetch('/api/admin/block-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: window.user.id })
        });
        alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
      } catch (e) {
        alert('‚ùå –û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏');
      }
    }

    async function loadReviews() {
      try {
        const res = await fetch('/api/admin/reviews');
        const reviews = await res.json();
        const container = document.getElementById('reviews-list');
        container.innerHTML = reviews.map(r => `
          <div style="padding: 10px; border-bottom: 1px solid #eee;">
            <strong>${r.first_name} (@${r.username})</strong> <span style="color: #FFA000;">‚≠ê ${r.rating}</span>
            <p style="margin: 8px 0;">${r.text}</p>
            <small>${new Date(r.created_at).toLocaleString()}</small>
            <div style="margin-top: 8px;">
              <button class="btn" style="background: #4CAF50; padding: 5px 10px;" onclick="approveReview(${r.id})">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
              <button class="btn" style="background: #F44336; padding: 5px 10px;" onclick="deleteReview(${r.id})">üóë –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        `).join('');
      } catch (e) {
        document.getElementById('reviews-list').innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∑—ã–≤–æ–≤</p>';
        console.error(e);
      }
    }

    async function loadSupportTickets() {
      try {
        const res = await fetch('/api/admin/support-tickets');
        const tickets = await res.json();
        const container = document.getElementById('support-list');
        container.innerHTML = tickets.map(t => `
          <div style="padding: 10px; border-bottom: 1px solid #eee;">
            <strong>@${t.username}</strong> ‚Äî <span style="color: #FF9800;">${t.subject}</span>
            <p style="margin: 8px 0; font-size: 14px;">${t.message}</p>
            <small>${new Date(t.created_at).toLocaleString()}</small>
            <div style="margin-top: 8px;">
              <button class="btn" style="background: #2196F3; padding: 5px 10px;" onclick="resolveTicket(${t.id})">‚úÖ –†–µ—à–µ–Ω–æ</button>
            </div>
          </div>
        `).join('');
      } catch (e) {
        document.getElementById('support-list').innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π</p>';
        console.error(e);
      }
    }

    function approveReview(id) { alert(`–û—Ç–∑—ã–≤ ${id} –ø—Ä–∏–Ω—è—Ç`); }
    function deleteReview(id) { alert(`–û—Ç–∑—ã–≤ ${id} —É–¥–∞–ª—ë–Ω`); }
    function resolveTicket(id) { alert(`–û–±—Ä–∞—â–µ–Ω–∏–µ ${id} –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ —Ä–µ—à—ë–Ω–Ω–æ–µ`); }

    function goBack() {
      window.Telegram?.WebApp?.close();
      window.location.href = "https://t.me/leo_aide_bot";
    }
  </script>
</body>
</html>