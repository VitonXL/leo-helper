{% extends "base.html" %}

{% block title %}üëÆ‚Äç‚ôÇÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block body_class %}tg-body{% endblock %}
{% block body_style %}background: var(--tg-theme-bg-color, #f4f6f8); color: var(--tg-theme-text-color, #212121);{% endblock %}

{% block content %}
  <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ -->
  <div style="margin-bottom: 20px; text-align: right;">
    <label style="color: var(--text-secondary);"><strong>–†–µ–∂–∏–º:</strong></label>
    <select id="view-mode" onchange="changeViewMode(this.value)" style="padding: 8px 12px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--card-bg); color: var(--text);">
      <option value="cards">–ö–∞—Ä—Ç–æ—á–∫–∏</option>
      <option value="table">–¢–∞–±–ª–∏—Ü–∞</option>
      <option value="chart">–ì—Ä–∞—Ñ–∏–∫</option>
      <option value="bars">–°—Ç–æ–ª–±—Ü—ã</option>
    </select>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div id="stats-container">
    {% include 'partials/loader.html' %}
  </div>

  <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
  <div class="card" style="margin-bottom: 30px;">
    <h3>üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
    <div style="display: flex; gap: 10px; margin: 15px 0;">
      <input type="text" id="search-user" placeholder="ID –∏–ª–∏ @username" style="flex: 1; padding: 12px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--card-bg); color: var(--text);">
      <button class="btn" onclick="searchUser()">–ü–æ–∏—Å–∫</button>
    </div>
    <div id="user-actions" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
      <p style="color: var(--text-secondary);"><strong>–ù–∞–π–¥–µ–Ω:</strong> <span id="found-user"></span></p>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn" style="background: #4CAF50;" onclick="confirmGrantPremium()">‚úÖ –í—ã–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º</button>
        <button class="btn" style="background: #FF9800;" onclick="confirmRevokePremium()">üö´ –°–Ω—è—Ç—å</button>
        <button class="btn" style="background: #F44336;" onclick="confirmBlockUser()">‚õî –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤ -->
  <div class="card" style="margin-bottom: 30px;">
    <h3>üìù –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤</h3>
    <div id="reviews-list">
      {% include 'partials/loader.html' %}
    </div>
  </div>

  <!-- –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞ -->
  <div class="card" style="margin-bottom: 30px;">
    <h3>üì¨ –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞</h3>
    <div id="support-list">
      {% include 'partials/loader.html' %}
    </div>
  </div>

  <!-- –®–∞–±–ª–æ–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤ -->
  <div class="card" style="margin-bottom: 30px;">
    <h3>üìù –®–∞–±–ª–æ–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤</h3>
    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
      <button class="btn" onclick="useTemplate('–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ! ‚úÖ')" style="padding: 8px 12px; font-size: 14px;">–°–ø–∞—Å–∏–±–æ</button>
      <button class="btn" onclick="useTemplate('–û—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.')" style="padding: 8px 12px; font-size: 14px;">–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ</button>
      <button class="btn" onclick="useTemplate('–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤–æ—à–ª–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç –∏ –æ–±–Ω–æ–≤–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É.')" style="padding: 8px 12px; font-size: 14px;">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ</button>
      <button class="btn" onclick="useTemplate('–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: https://leo-aide.online/faq')" style="padding: 8px 12px; font-size: 14px;">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
      <button class="btn" onclick="useTemplate('–ú—ã –ø–æ–ª—É—á–∏–ª–∏ –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∏ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ –Ω–∏–º.')" style="padding: 8px 12px; font-size: 14px;">–û–±—Ä–∞–±–æ—Ç–∫–∞</button>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
  {% include 'partials/toast.html' %}
  {% include 'partials/modal.html' %}
  {% include 'partials/loader.html' %}

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    let statsData = {};
    let currentChart = null;

    document.addEventListener('DOMContentLoaded', async () => {
      await loadStats();
      await loadReviews();
      await loadSupportTickets();
      changeViewMode('cards');
    });

    async function loadStats() {
      try {
        const res = await fetch('/api/admin/stats');
        statsData = await res.json();
        renderStatsCards();
      } catch (e) {
        document.getElementById('stats-container').innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
        Toast.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É');
      }
    }

    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (renderStatsCards –∏ —Ç.–¥.) ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

    function confirmGrantPremium() {
      confirmAction(
        `–í—ã–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º @${window.user.username}?`,
        grantPremium,
        '–í—ã–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º?'
      );
    }

    async function grantPremium() {
      try {
        await fetch('/api/admin/grant-premium', { method: 'POST', body: JSON.stringify({ user_id: window.user.id }) });
        Toast.success('‚úÖ –ü—Ä–µ–º–∏—É–º –≤—ã–¥–∞–Ω');
      } catch (e) {
        Toast.error('‚ùå –û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏');
      }
    }

    // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è revoke, block, approve, delete...
  </script>
{% endblock %}