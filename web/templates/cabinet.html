{% extends "base.html" %}

{% block title %}–ö–∞–±–∏–Ω–µ—Ç{% endblock %}

{% block body_class %}tg-body{% endblock %}
{% block body_style %}background: var(--tg-theme-bg-color, #f4f6f8); color: var(--tg-theme-text-color, #212121);{% endblock %}

{% block header %}
  <!-- –•–µ–¥–µ—Ä —Å –≥–∞–º–±—É—Ä–≥–µ—Ä–æ–º -->
  <header style="display: flex; align-items: center; gap: 16px; margin-bottom: 30px;">
    <div class="hamburger" onclick="toggleSidebar()" style="cursor: pointer; font-size: 24px;">‚ò∞</div>
    <h1 style="margin: 0; font-size: 24px; color: var(--accent);">üë§ {{ user.first_name }}</h1>
  </header>
{% endblock %}

{% block content %}

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <div class="card user-profile">
    <div class="avatar" style="background-color: #{{ '%06x' % (user.id % 0xFFFFFF) }}; width: 80px; height: 80px; font-size: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin: 0 auto 16px;">
      {{ user.first_name[0].upper() }}
    </div>
    <h2 style="text-align: center; margin: 0 0 8px 0;">{{ user.first_name }}</h2>
    {% if user.is_premium %}
      <p style="text-align: center; margin: 0 0 16px 0;">
        <img src="/static/premium.svg" alt="Premium" style="width: 18px; height: 18px; margin-right: 4px; vertical-align: middle;"> 
        <strong style="color: #DAA520;">–ü—Ä–µ–º–∏—É–º</strong>
      </p>
    {% endif %}
    <p style="text-align: center; color: var(--text-secondary); font-size: 14px;">ID: <code style="background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px;">{{ user.id }}</code></p>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="card user-stats">
    <h3>üìä –§–∏–Ω–∞–Ω—Å—ã</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
      <div class="stat-item">
        <label>–î–æ—Ö–æ–¥</label>
        <span>{{ "%.2f"|format(stats.income) }} ‚ÇΩ</span>
      </div>
      <div class="stat-item">
        <label>–†–∞—Å—Ö–æ–¥</label>
        <span>{{ "%.2f"|format(stats.expense) }} ‚ÇΩ</span>
      </div>
      <div class="stat-item" style="grid-column: span 2;">
        <label>–ë–∞–ª–∞–Ω—Å</label>
        <span style="font-weight: 700; color: {{ 'green' if stats.balance >= 0 else 'red' }};">
          {{ "%.2f"|format(stats.balance) }} ‚ÇΩ
        </span>
      </div>
    </div>
  </div>

  <!-- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ -->
  <div class="card referral-section">
    <h3>üë• –†–µ—Ñ–µ—Ä–∞–ª—ã</h3>
    <p style="color: var(--text-secondary); font-size: 14px;">–í—ã –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏: <strong>{{ user.referrals }}</strong></p>
    <button class="btn" onclick="copyReferralLink()" style="width: 100%;">
      üì• –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
    </button>
  </div>

{% endblock %}

{% block footer %}
  <!-- FAB ‚Äî –∑–∞–∫—Ä—ã—Ç—å -->
  <button class="fab" onclick="closeApp()">‚úï</button>
{% endblock %}

{% block scripts %}

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
  {% include 'partials/toast.html' %}
  {% include 'partials/modal.html' %}
  {% include 'partials/loader.html' %}

  <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <h3>–ú–µ–Ω—é</h3>
      <span class="close-btn" onclick="toggleSidebar()" style="cursor: pointer;">‚úï</span>
    </div>
    <ul class="sidebar-menu">
      <li><a href="/cabinet" onclick="navigateTo('profile'); toggleSidebar();">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a></li>
      <li><a href="/finance" onclick="navigateTo('finance'); toggleSidebar();">üí∞ –§–∏–Ω–∞–Ω—Å—ã</a></li>
      <li><a href="/settings" onclick="navigateTo('settings'); toggleSidebar();">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></li>
      <li><a href="/support" onclick="navigateTo('support'); toggleSidebar();">üì¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a></li>
      <li><a href="/premium" onclick="navigateTo('premium'); toggleSidebar();">üíé –ü–æ–¥–ø–∏—Å–∫–∞</a></li>
      <li><a href="/admin" onclick="navigateTo('admin'); toggleSidebar();">üëÆ‚Äç‚ôÇÔ∏è –ê–¥–º–∏–Ω</a></li>
    </ul>
    <div class="sidebar-footer">
      <button class="btn" onclick="toggleTheme()">
        <span id="theme-icon">{{ '‚òÄÔ∏è' if theme == 'dark' else 'üåô' }}</span>
        <span id="theme-label">{{ '–°–≤–µ—Ç–ª–∞—è' if theme == 'dark' else '–¢—ë–º–Ω–∞—è' }} —Ç–µ–º–∞
      </button>
    </div>
  </div>

  <!-- –û–≤–µ—Ä–ª–µ–π -->
  <div class="overlay" onclick="toggleSidebar()" style="display: none;"></div>

  <!-- –°–∫—Ä–∏–ø—Ç—ã -->
  <script>
    // –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.overlay');
      if (sidebar && overlay) {
        sidebar.classList.toggle('open');
        overlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
      }
    }

    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
    function copyReferralLink() {
      const user_id = {{ user.id }};
      const refLink = `https://t.me/Leo_aide_bot?start=ref_${user_id}`;
      navigator.clipboard.writeText(refLink).then(() => {
        Toast.info('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
      }).catch(err => {
        Toast.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
      });
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
    function toggleTheme() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const newTheme = isDark ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –∏ —Ç–µ–∫—Å—Ç
      document.getElementById('theme-icon').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
      document.getElementById('theme-label').textContent = isDark ? '–¢—ë–º–Ω–∞—è' : '–°–≤–µ—Ç–ª–∞—è';

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º
      document.cookie = `theme=${newTheme}; path=/; max-age=31536000`;

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      const urlParams = new URLSearchParams(window.location.search);
      const user_id = urlParams.get('user_id');
      const hash = urlParams.get('hash');
      if (user_id && hash) {
        fetch('/api/set-theme', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: parseInt(user_id), theme: newTheme, hash })
        }).catch(console.warn);
      }
    }

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', () => {
      const savedTheme = getCookie('theme') || '{{ theme }}' || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      Toast.info('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.first_name }}!');
    });

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
  </script>
{% endblock %}