{% extends "base.html" %}

{% block title %}–õ–µ–æ ‚Äî –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç{% endblock %}

{% block styles %}
<style>
/* === –ï–î–ò–ù–ê–Ø –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê === */
:root {
  --bg: #ffffff;
  --card-bg: rgba(255, 255, 255, 0.95);
  --text: #212121;
  --text-secondary: #757575;
  --border: rgba(178, 255, 89, 0.2);
  --accent: #4CAF50;
  --accent-light: #B2FF59;
  --gold: linear-gradient(-45deg, #DAA520, #FFD700, #F4C430, #C5B358, #DAA520);
  --radius-sm: 8px;
  --radius-md: 16px;
  --radius-lg: 24px;
  --shadow: 0 6px 20px rgba(76, 175, 80, 0.08);
  --shadow-hover: 0 12px 28px rgba(76, 175, 80, 0.16), 0 16px 40px rgba(0, 0, 0, 0.12);
  --transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

/* === –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê === */
[data-theme="dark"] {
  --bg: #121212;
  --card-bg: rgba(30, 30, 30, 0.95);
  --text: #ffffff;
  --text-secondary: #b0b0b0;
  --border: rgba(178, 255, 89, 0.1);
}

/* === –ì–õ–ê–í–ù–´–ô –§–û–ù === */
body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: background 0.3s, color 0.3s;
}

/* === –°–ê–ô–î–ë–ê–† === */
.sidebar {
  position: fixed;
  left: -280px;
  top: 0;
  width: 280px;
  height: 100%;
  background: var(--card-bg);
  box-shadow: var(--shadow-hover);
  z-index: 1000;
  transition: left 0.3s ease;
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
}

.sidebar.open {
  left: 0;
}

.logo {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 20px;
  font-size: 24px;
  font-weight: 700;
  color: var(--accent);
  border-bottom: 1px solid var(--border);
}

nav {
  padding: 20px 0;
  flex: 1;
}

.nav-link {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  color: var(--text);
  text-decoration: none;
  font-size: 16px;
  transition: var(--transition);
  border-left: 4px solid transparent;
}

.nav-link:hover,
.nav-link.active {
  background: rgba(76, 175, 80, 0.1);
  border-left: 4px solid var(--accent);
}

.nav-link.active {
  font-weight: 500;
}

/* === –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ === */
.main-content {
  margin-left: 0;
  transition: margin-left 0.3s ease;
}

.sidebar.open ~ .main-content {
  margin-left: 280px;
}

header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--card-bg);
  position: sticky;
  top: 0;
  z-index: 900;
}

.hamburger {
  font-size: 24px;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  transition: background 0.2s;
}

.hamburger:hover {
  background: rgba(0,0,0,0.05);
}

.header-icons {
  display: flex;
  align-items: center;
  gap: 16px;
}

.material-icons {
  cursor: pointer;
  user-select: none;
}

.avatar {
  width: 40px;
  height: 40px;
  background-color: #4CAF50;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 500;
  font-size: 16px;
}

/* === –ö–û–ù–¢–ï–ô–ù–ï–† === */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* === –ö–ê–†–¢–´ === */
.card {
  background: var(--card-bg);
  border-radius: var(--radius-md);
  padding: 24px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  margin-bottom: 20px;
  transition: transform var(--transition);
}

.card:hover {
  transform: translateY(-2px);
}

.card.highlight {
  background: linear-gradient(135deg, #B2FF59, #CCFF90);
  position: relative;
  overflow: hidden;
}

.card.highlight::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 6px;
  background: var(--gold);
  background-size: 400% 400%;
  animation: shimmer-gold-strong 6s ease-in-out infinite;
}

/* === –ó–ê–ì–û–õ–û–í–ö–ò === */
.section-title {
  font-size: 18px;
  font-weight: 500;
  margin: 24px 0 12px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-title::before {
  content: '';
  flex: 1;
  height: 1px;
  background: linear-gradient(to right, transparent, var(--accent-light), transparent);
}

/* === –ö–ù–û–ü–ö–ò === */
.btn {
  padding: 12px 24px;
  border: none;
  border-radius: var(--radius-sm);
  background: var(--accent);
  color: white;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
}

.btn-primary {
  background: var(--accent);
}

.btn-sm {
  padding: 8px 16px;
  font-size: 14px;
}

/* === –ë–´–°–¢–†–´–ï –î–ï–ô–°–¢–í–ò–Ø === */
.button-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  margin-bottom: 30px;
}

.action-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px;
  text-align: center;
  color: var(--text);
  text-decoration: none;
  transition: background 0.3s ease;
}

.action-btn:hover {
  background: rgba(76, 175, 80, 0.05);
}

.action-icon {
  font-size: 28px;
  margin-bottom: 8px;
}

.action-label {
  font-size: 15px;
  font-weight: 500;
}

/* === –í–ò–î–ñ–ï–¢–´ === */
.widget-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  margin-bottom: 30px;
}

.widget {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 16px;
  text-align: center;
  font-size: 14px;
}

.widget-icon {
  font-size: 28px;
  margin-bottom: 8px;
}

.widget-title {
  font-size: 14px;
  color: var(--text-secondary);
  margin: 4px 0;
}

.widget-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
}

.widget-sub {
  font-size: 12px;
  color: var(--text-secondary);
}

/* === –ù–û–í–û–°–¢–ò === */
.news-feed {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
}

.news-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--card-bg);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
}

.news-icon {
  font-size: 24px;
}

.news-content {
  flex: 1;
}

.news-title {
  font-size: 15px;
  font-weight: 500;
  margin: 0 0 4px 0;
}

.news-time {
  font-size: 12px;
  color: var(--text-secondary);
  margin: 0;
}

.news-footer {
  text-align: center;
  margin: 16px 0;
}

/* === PREMIUM BADGE === */
.subscription-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.subscription-badge.premium {
  background: var(--gold);
  background-size: 400% 400%;
  animation: shimmer-gold-strong 6s ease-in-out infinite;
  box-shadow: 0 2px 8px rgba(218, 165, 32, 0.3);
}

/* === FAB ‚Äî –£–î–ê–õ–Å–ù (–ø–æ —Ç–≤–æ–µ–º—É –∂–µ–ª–∞–Ω–∏—é) === */

/* === –û–í–ï–†–õ–ï–ô === */
.overlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 999;
}

/* === –ê–ù–ò–ú–ê–¶–ò–ò === */
@keyframes shimmer-gold-strong {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
  70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
  100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
}

/* === –ê–î–ê–ü–¢–ò–í === */
@media (max-width: 768px) {
  .widget-grid,
  .button-grid {
    grid-template-columns: 1fr;
  }
  .sidebar {
    left: -100%;
  }
}
</style>
{{ super() }}
{% endblock %}

{% block content %}

  <!-- –°–∞–π–¥–±–∞—Ä -->
  {% include 'partials/sidebar.html' %}

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <div class="main-content">
    {% include 'partials/header.html' %}

    <div class="container">

      <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
      <div class="card highlight" id="welcome-card">
        <div class="subscription-badge" id="sub-badge">–ë–∞–∑–æ–≤–∞—è</div>
        <h2>üå± –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –õ–µ–æ</h2>
        <p>–í–∞—à –ª–∏—á–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ –º–∏—Ä–µ Telegram. –ó–¥–µ—Å—å ‚Äî –≤—Å—ë, —á—Ç–æ –Ω—É–∂–Ω–æ.</p>
        <button class="btn-primary" onclick="navigateTo('premium')">
          {{ '–£–ø—Ä–∞–≤–ª—è—Ç—å' if user.is_premium else '–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–º–∏—É–º' }}
        </button>
      </div>

      <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
      <div class="section-title">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
      <div class="button-grid">
        <a href="/finance?user_id={{ user.id }}&hash={{ request.query_params.hash }}" class="action-btn">
          <div class="action-icon">üí∞</div>
          <div class="action-label">–§–∏–Ω–∞–Ω—Å—ã</div>
        </a>
        <a href="#" class="action-btn" onclick="navigateTo('weather')">
          <div class="action-icon">üå¶</div>
          <div class="action-label">–ü–æ–≥–æ–¥–∞</div>
        </a>
        <a href="#" class="action-btn" onclick="navigateTo('gigachat')">
          <div class="action-icon">üí¨</div>
          <div class="action-label">GigaChat</div>
        </a>
        <a href="#" class="action-btn" onclick="navigateTo('games')">
          <div class="action-icon">üéÆ</div>
          <div class="action-label">–ò–≥—Ä—ã</div>
        </a>
      </div>

      <!-- –í–∏–¥–∂–µ—Ç—ã -->
      <div class="widget-grid">
        <div class="widget weather-widget">
          <div class="widget-icon">üå§</div>
          <div class="widget-title">–ü–æ–≥–æ–¥–∞</div>
          <div class="widget-value"><span id="current-temp">+12¬∞C</span></div>
          <div class="widget-sub">–≤ –ú–æ—Å–∫–≤–µ</div>
        </div>
        <div class="widget currency-widget">
          <div class="widget-icon">üíµ</div>
          <div class="widget-title">–ö—É—Ä—Å USD</div>
          <div class="widget-value"><span id="usd-rate">98.50</span> ‚ÇΩ</div>
          <div class="widget-sub">–Ω–∞ —Å–µ–≥–æ–¥–Ω—è</div>
        </div>
        <div class="widget chat-widget">
          <div class="widget-icon">ü§ñ</div>
          <div class="widget-title">GigaChat</div>
          <div class="widget-value">{{ user.gigachat_requests or 0 }}/10</div>
          <div class="widget-sub">–∑–∞–ø—Ä–æ—Å–æ–≤</div>
        </div>
        <div class="widget reminder-widget">
          <div class="widget-icon">üõé</div>
          <div class="widget-title">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</div>
          <div class="widget-value">{{ user.reminders or 2 }}</div>
          <div class="widget-sub">–∞–∫—Ç–∏–≤–Ω—ã—Ö</div>
        </div>
      </div>

      <!-- –ù–æ–≤–æ—Å—Ç–∏ -->
      <div class="section-title">üì∞ –ù–æ–≤–æ—Å—Ç–∏ –¥–Ω—è</div>
      <div class="news-feed" id="news-feed"></div>
      <div class="news-footer">
        <button class="btn-sm" onclick="loadMoreNews()">–ï—â—ë –Ω–æ–≤–æ—Å—Ç–∏</button>
      </div>

    </div>
  </div>

  <!-- –û–≤–µ—Ä–ª–µ–π -->
  <div class="overlay" onclick="toggleSidebar()"></div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    const userData = {
      id: {{ user.id }},
      firstName: "{{ user.first_name|default('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', true) }}",
      isPremium: {{ "true" if user.is_premium else "false" }},
      role: "{{ user.role|default('user', true) }}",
      gigachat_requests: {{ user.gigachat_requests or 0 }},
      reminders: {{ user.reminders or 2 }}
    };

    function updateGreeting() {
      const hour = new Date().getHours();
      const map = { 5: "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ", 12: "–î–æ–±—Ä—ã–π –¥–µ–Ω—å", 18: "–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä", 22: "–î–æ–±—Ä–æ–π –Ω–æ—á–∏" };
      const icons = { 5: "‚òÄÔ∏è", 12: "üå§", 18: "üåô", 22: "üò¥" };
      let g = "–ü—Ä–∏–≤–µ—Ç", i = "üôÇ";
      for (const h in map) if (hour >= h) { g = map[h]; i = icons[h]; }
      document.getElementById('greeting').textContent = g;
      document.getElementById('mood-icon').textContent = i;
    }

    const badge = document.getElementById('sub-badge');
    if (badge) {
      if (userData.isPremium) {
        badge.textContent = '–ü—Ä–µ–º–∏—É–º';
        badge.classList.add('premium');
      } else {
        badge.textContent = '–ë–∞–∑–æ–≤–∞—è';
      }
    }

    if (userData.role === 'admin' && document.getElementById('admin-link')) {
      document.getElementById('admin-link').style.display = 'flex';
    }

    const mockNews = [
      { icon: "üåç", title: "–ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ –ø—Ä–µ–≤—ã—Å–∏–ª 99 —Ä—É–±–ª–µ–π", time: "10 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥" },
      { icon: "ü§ñ", title: "Sber –∑–∞–ø—É—Å—Ç–∏–ª –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é GigaChat", time: "35 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥" },
      { icon: "üå§", title: "–í –ú–æ—Å–∫–≤–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è –ø–æ—Ç–µ–ø–ª–µ–Ω–∏–µ –¥–æ +14¬∞C", time: "1 —á–∞—Å –Ω–∞–∑–∞–¥" },
      { icon: "üí∞", title: "–¶–ë –†–§ –æ–±—ä—è–≤–∏–ª –æ –Ω–æ–≤—ã—Ö –º–µ—Ä–∞—Ö –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä—É–±–ª—è", time: "2 —á–∞—Å–∞ –Ω–∞–∑–∞–¥" },
      { icon: "üì±", title: "Telegram –æ–±–Ω–æ–≤–∏–ª —Ñ—É–Ω–∫—Ü–∏—é Mini Apps", time: "3 —á–∞—Å–∞ –Ω–∞–∑–∞–¥" },
      { icon: "‚ö°", title: "–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥ –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –≤ –†–§", time: "4 —á–∞—Å–∞ –Ω–∞–∑–∞–¥" }
    ];

    function renderNews(count = 3) {
      const container = document.getElementById('news-feed');
      if (!container) return;
      container.innerHTML = '';
      const toShow = mockNews.slice(0, count);
      toShow.forEach(news => {
        const item = document.createElement('div');
        item.className = 'news-item';
        item.innerHTML = `
          <div class="news-icon">${news.icon}</div>
          <div class="news-content">
            <div class="news-title">${news.title}</div>
            <div class="news-time">${news.time}</div>
          </div>
        `;
        container.appendChild(item);
      });
    }

    function loadMoreNews() {
      const currentCount = document.querySelectorAll('.news-item').length;
      const nextCount = Math.min(currentCount + 3, mockNews.length);
      renderNews(nextCount);
    }

    function toggleTheme() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const newTheme = isDark ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      document.getElementById('theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      document.cookie = `theme=${newTheme}; path=/; max-age=31536000`;
      const urlParams = new URLSearchParams(window.location.search);
      const user_id = urlParams.get('user_id');
      const hash = urlParams.get('hash');
      if (user_id && hash) {
        fetch('/api/set-theme', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: parseInt(user_id), theme: newTheme, hash })
        }).catch(console.warn);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const savedTheme = getCookie('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      updateGreeting();
      renderNews(3);
      Toast.info('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + userData.firstName + '!');
    });

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
  </script>
{% endblock %}