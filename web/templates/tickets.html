{% extends "base.html" %}
{% block content %}

<div class="card">
    <h2 style="color: var(--accent); font-weight: 600; margin-bottom: 16px;">
        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">headset_mic</span>
        Техподдержка
    </h2>
    <p style="color: var(--text-secondary); margin-bottom: 24px;">
        Отвечайте на запросы пользователей. Только для модераторов и админов.
    </p>

    {% if tickets|length == 0 %}
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
            <span class="material-icons" style="font-size: 48px; opacity: 0.5;">inbox</span>
            <p style="margin-top: 12px;">Нет открытых тикетов</p>
        </div>
    {% else %}
        <div style="display: grid; gap: 16px;">
            {% for ticket in tickets %}
            <div class="card" style="padding: 16px; border-left: 4px solid var(--accent); background: var(--bg-secondary);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                    <div>
                        <strong style="color: var(--text-primary);">{{ ticket.first_name }}</strong>
                        {% if ticket.username %}
                            <span style="color: var(--text-secondary); margin-left: 8px;">@{{ ticket.username }}</span>
                        {% endif %}
                    </div>
                    <span class="btn-sm" style="background: var(--accent-light); color: #006400; width: auto; padding: 4px 12px; font-size: 12px;">
                        {{ ticket.created_at }}
                    </span>
                </div>

                <p style="color: var(--text-primary); margin: 8px 0; font-size: 14px; line-height: 1.5;">
                    {{ ticket.message }}
                </p>

                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <span class="
                        {% if ticket.status == 'open' %} 
                            btn-sm" style="background: #e8f5e9; color: #2e7d32; 
                        {% elif ticket.status == 'in_progress' %} 
                            btn-sm" style="background: #fff8e1; color: #f57f17; 
                        {% else %} 
                            btn-sm" style="background: #e8f5e9; color: #2e7d32; 
                        {% endif %}
                        width: auto; padding: 6px 12px; font-size: 12px;">
                        {% if ticket.status == 'open' %}Новый{% elif ticket.status == 'in_progress' %}В работе{% else %}Закрыт{% endif %}
                    </span>

                    <button 
                        class="btn-sm" 
                        style="background: var(--accent); color: white; width: auto;"
                        data-ticket-id="{{ ticket.ticket_id }}"
                        data-user-id="{{ ticket.user_id }}"
                        data-bs-toggle="modal" 
                        data-bs-target="#replyModal">
                        Ответить
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    {% endif %}
</div>

<!-- Модальное окно для ответа -->
<div class="modal fade" id="replyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 16px; overflow: hidden;">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-light);">
                <h5 class="modal-title" style="color: var(--text-primary);">Ответить пользователю</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="currentTicketId"/>
                <div class="mb-3">
                    <label class="form-label" style="color: var(--text-primary);">Шаблоны ответов</label>
                    <div id="templates-container" style="display: grid; gap: 8px; margin-top: 8px;"></div>
                </div>
                <div class="mb-3">
                    <label for="replyText" class="form-label" style="color: var(--text-primary);">Текст ответа</label>
                    <textarea 
                        class="form-control" 
                        id="replyText" 
                        rows="4" 
                        placeholder="Введите ответ..." 
                        style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; padding: 12px; resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-light);">
                <button type="button" class="btn-sm" data-bs-dismiss="modal" style="background: #e0e0e0; color: #333; width: auto;">Отмена</button>
                <button type="button" class="btn-primary" id="sendReplyBtn" style="width: auto; padding: 8px 16px;">Отправить</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const userId = "{{ user_id }}";
    const hash = "{{ hash }}";

    // Загружаем шаблоны ответов
    async function loadTemplates() {
        try {
            const res = await fetch(`/api/admin/reply-templates?user_id=${userId}&hash=${hash}`);
            const data = await res.json();
            const container = document.getElementById("templates-container");

            data.templates.forEach(tpl => {
                const btn = document.createElement("button");
                btn.className = "btn-sm";
                btn.style = "width: 100%; text-align: left; background: var(--bg-hover); border: 1px solid var(--border-light);";
                btn.innerHTML = `<strong style="color: var(--accent);">${tpl.title}</strong>: ${tpl.text}`;
                btn.onclick = () => document.getElementById("replyText").value = tpl.text;
                container.appendChild(btn);
            });
        } catch (e) {
            console.error("Ошибка загрузки шаблонов:", e);
            Toast.error("Не удалось загрузить шаблоны");
        }
    }

    // Обработка открытия модалки
    document.addEventListener("DOMContentLoaded", () => {
        loadTemplates();

        const modal = document.getElementById("replyModal");
        modal.addEventListener("show.bs.modal", (event) => {
            const button = event.relatedTarget;
            const ticketId = button.getAttribute("data-ticket-id");
            document.getElementById("currentTicketId").value = ticketId;
            document.getElementById("replyText").value = "";
        });

        // Отправка ответа
        document.getElementById("sendReplyBtn").addEventListener("click", async () => {
            const ticketId = document.getElementById("currentTicketId").value;
            const replyText = document.getElementById("replyText").value.trim();

            if (!replyText) {
                Toast.warning("Введите текст ответа");
                return;
            }

            const btn = document.getElementById("sendReplyBtn");
            btn.disabled = true;
            btn.innerHTML = "Отправка...";

            try {
                const res = await fetch("/api/admin/reply-support", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ ticket_id: ticketId, reply_text: replyText })
                });

                if (res.ok) {
                    Toast.success("Ответ отправлен, тикет закрыт");
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const data = await res.json();
                    Toast.error(data.detail || "Ошибка отправки");
                }
            } catch (e) {
                Toast.error("Ошибка сети");
            } finally {
                btn.disabled = false;
                btn.innerHTML = "Отправить";
            }
        });
    });
</script>
{% endblock %}