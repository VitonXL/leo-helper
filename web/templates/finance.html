{% extends "base.html" %}

{% block title %}–õ–µ–æ ‚Äî –§–∏–Ω–∞–Ω—Å—ã{% endblock %}

{% block styles %}
<style>
/* === –ï–î–ò–ù–ê–Ø –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê === */
:root {
  --bg: transparent;
  --card-bg: rgba(255, 255, 255, 0.95);
  --text: #212121;
  --text-secondary: #757575;
  --border: rgba(178, 255, 89, 0.2);
  --accent: #4CAF50;
  --accent-light: #B2FF59;
  --gold: linear-gradient(-45deg, #DAA520, #FFD700, #F4C430, #C5B358, #DAA520);
  --gold-soft: linear-gradient(-45deg, #D4A017, #E6C229, #F4C430, #D4A017);
  --radius-sm: 8px;
  --radius-md: 16px;
  --radius-lg: 24px;
  --shadow: 0 6px 20px rgba(76, 175, 80, 0.08);
  --shadow-hover: 0 12px 28px rgba(76, 175, 80, 0.16), 0 16px 40px rgba(0, 0, 0, 0.12);
  --transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

/* === –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê === */
[data-theme="dark"] {
  --bg: transparent;
  --card-bg: rgba(30, 30, 30, 0.95);
  --text: #ffffff;
  --text-secondary: #b0b0b0;
  --border: rgba(178, 255, 89, 0.1);
}

/* === –ì–õ–ê–í–ù–´–ô –§–û–ù === */
body, html {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: 'Inter', sans-serif;
  color: var(--text);
  background: linear-gradient(135deg, #f0fff0, #d9f7d9, #e6ffeb);
  background-size: 400% 400%;
  animation: gradient-shift 15s ease infinite;
  min-height: 100vh;
  overflow-x: hidden;
}

[data-theme="dark"] body {
  background: linear-gradient(135deg, #0a1e0a, #0c240c, #0d2a0d);
}

@keyframes gradient-shift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* === –ö–û–ù–¢–ï–ô–ù–ï–† === */
.container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 20px;
}

/* === –ù–ê–í–ò–ì–ê–¶–ò–Ø –°–í–ï–†–•–£ (–µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å —Å –∫–∞–±–∏–Ω–µ—Ç–æ–º) === */
.navbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--card-bg);
  padding: 16px 20px;
  border-radius: var(--radius-md);
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  margin-bottom: 30px;
  z-index: 100;
}

.navbar-title {
  font-size: 20px;
  font-weight: 600;
  color: var(--accent);
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 0;
}

.navbar-actions {
  display: flex;
  gap: 12px;
}

.nav-btn {
  padding: 8px 16px;
  border: 1px solid var(--border);
  background: var(--card-bg);
  color: var(--text);
  border-radius: var(--radius-sm);
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.nav-btn:hover {
  background: rgba(76, 175, 80, 0.08);
  transform: translateY(-1px);
}

.nav-btn.accent {
  background: var(--accent);
  color: white;
}

.nav-btn.accent:hover {
  background: #3d8b40;
}

/* === –ö–ê–†–¢–´ === */
.card {
  background: var(--card-bg);
  border-radius: var(--radius-md);
  padding: 24px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  margin-bottom: 24px;
  transition: transform var(--transition);
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-hover);
}

.card h3 {
  margin: 0 0 16px 0;
  font-size: 20px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 10px;
}

/* === –§–û–†–ú–´ === */
.form-group {
  margin-bottom: 18px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  color: var(--text-secondary);
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 15px;
  background: var(--card-bg);
  color: var(--text);
  box-sizing: border-box;
}

.form-control:focus {
  outline: none;
  border-color: var(--accent);
}

/* === –ö–ê–¢–ê–õ–û–ì–ò –ö–ù–û–ü–ö–ò === */
.catalog-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 16px;
  margin-top: 12px;
}

.catalog-btn {
  background: rgba(76, 175, 80, 0.06);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 16px;
  text-align: left;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.catalog-btn:hover {
  background: rgba(76, 175, 80, 0.12);
  transform: translateY(-2px);
}

.catalog-btn.active {
  border-color: var(--accent);
  background: rgba(76, 175, 80, 0.15);
  font-weight: 600;
}

.catalog-btn .icon {
  font-size: 28px;
  margin-bottom: 8px;
}

.catalog-btn .name {
  font-weight: 600;
  display: block;
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 180px;
}

.catalog-btn .currency {
  font-size: 12px;
  color: var(--text-secondary);
  background: rgba(218, 165, 32, 0.2);
  padding: 2px 8px;
  border-radius: 12px;
  margin-right: 6px;
}

.catalog-btn .stats {
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 6px;
}

.catalog-btn .delete {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #f44336;
  color: white;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  cursor: pointer;
  opacity: 0;
}

.catalog-btn:hover .delete {
  opacity: 1;
}

/* === –û–ü–ï–†–ê–¶–ò–ò === */
.operation-list {
  max-height: 320px;
  overflow-y: auto;
  margin-top: 16px;
  border-top: 1px solid var(--border);
  padding-top: 12px;
  padding-right: 8px;
}

.operation {
  display: flex;
  justify-content: space-between;
  padding: 10px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
}

.operation:last-child {
  border-bottom: none;
}

.operation.income {
  color: #4CAF50;
}

.operation.expense {
  color: #f44336;
}

.operation .note {
  flex: 1;
  font-weight: 500;
}

.operation .meta {
  font-size: 12px;
  color: var(--text-secondary);
  text-align: right;
  min-width: 110px;
}

/* === –ö–ù–û–ü–ö–ò === */
.btn {
  padding: 12px 24px;
  border: none;
  border-radius: var(--radius-sm);
  color: white;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.2);
  background: #4CAF50;
  margin-bottom: 8px;
}

.btn-primary {
  background: var(--gold);
  background-size: 200% 200%;
  animation: gradient-shift-gold 3s ease infinite;
  color: white;
}

.btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(76, 175, 80, 0.25);
}

.btn:active {
  transform: translateY(-1px);
}

/* === –ê–ù–ò–ú–ê–¶–ò–ò === */
@keyframes gradient-shift-gold {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* === –ê–î–ê–ü–¢–ò–í === */
@media (max-width: 768px) {
  .container {
    padding: 16px;
  }
  .catalog-grid {
    grid-template-columns: 1fr;
  }
  .catalog-btn .name {
    max-width: 140px;
  }
  .navbar {
    flex-direction: column;
    gap: 12px;
    text-align: center;
  }
  .navbar-actions {
    width: 100%;
    justify-content: center;
  }
}
</style>
{{ super() }}
{% endblock %}

{% block content %}
  <div class="container">

    <!-- –ï–î–ò–ù–û–ï –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–û–ï –ú–ï–ù–Æ (–∫–∞–∫ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ) -->
    <div class="navbar">
      <h2 class="navbar-title">
        <span class="material-icons">payments</span> –§–∏–Ω–∞–Ω—Å—ã
      </h2>
      <div class="navbar-actions">
        <button class="nav-btn" onclick="history.back()">
          <span class="material-icons">arrow_back</span> –ù–∞–∑–∞–¥
        </button>
        <button class="nav-btn" onclick="toggleTheme()">
          <span class="material-icons" id="theme-icon">dark_mode</span> –¢–µ–º–∞
        </button>
        <button class="nav-btn accent" onclick="window.location.href='/cabinet'">
          <span class="material-icons">account_circle</span> –ö–∞–±–∏–Ω–µ—Ç
        </button>
      </div>
    </div>

    <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ -->
    <div class="card">
      <h3><span class="material-icons">add</span> –ù–æ–≤—ã–π –∫–∞—Ç–∞–ª–æ–≥</h3>
      <div class="form-group">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" class="form-control" id="catalog-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: YouTube-–∫–∞–Ω–∞–ª">
      </div>
      <div class="form-group">
        <label>–ò–∫–æ–Ω–∫–∞</label>
        <select class="form-control" id="catalog-icon">
          <option value="üìÅ">üìÅ –ü–∞–ø–∫–∞</option>
          <option value="üìà">üìà –†–æ—Å—Ç</option>
          <option value="üí∞">üí∞ –î–µ–Ω—å–≥–∏</option>
          <option value="üî•">üî• –û–≥–æ–Ω—å</option>
          <option value="üéØ">üéØ –¶–µ–ª—å</option>
        </select>
      </div>
      <div class="form-group">
        <label>–í–∞–ª—é—Ç–∞</label>
        <select class="form-control" id="catalog-currency">
          <option value="RUB">üá∑üá∫ RUB (—Ä—É–±–ª—å)</option>
          <option value="USD">üá∫üá∏ USD (–¥–æ–ª–ª–∞—Ä)</option>
          <option value="EUR">üá™üá∫ EUR (–µ–≤—Ä–æ)</option>
          <option value="BTC">‚Çø BTC (–±–∏—Ç–∫–æ–∏–Ω)</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="createCatalog()">üìÅ –°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥</button>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ -->
    <div class="card">
      <h3><span class="material-icons">folder</span> –ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã</h3>
      <div class="catalog-grid" id="catalog-list">
        <div class="empty">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ç–∞–ª–æ–≥–æ–≤</div>
      </div>
    </div>

    <!-- –û–ø–µ—Ä–∞—Ü–∏–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ -->
    <div class="card" id="catalog-operations" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>
          <span id="current-icon">üìÅ</span>
          <span id="current-catalog">[–ö–∞—Ç–∞–ª–æ–≥]</span>
          <span class="currency" id="current-currency">RUB</span>
        </h3>
        <button class="btn" style="padding: 8px 16px; font-size: 14px;" onclick="convertCurrency()">
          üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
      </div>

      <div class="form-group">
        <label>–°—É–º–º–∞</label>
        <input type="number" class="form-control" id="op-amount" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5000">
      </div>

      <div class="form-group">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <input type="text" class="form-control" id="op-note" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö—É–ø–∏–ª –º–∏–∫—Ä–æ—Ñ–æ–Ω">
      </div>

      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="btn" onclick="addIncomeToCatalog()">‚ûï –î–æ—Ö–æ–¥</button>
        <button class="btn" onclick="addExpenseToCatalog()">‚ûñ –†–∞—Å—Ö–æ–¥</button>
      </div>

      <h4 style="margin: 20px 0 12px; color: var(--text-secondary);">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h4>
      <div class="operation-list" id="op-list"></div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // –î–∞–Ω–Ω—ã–µ
    let catalogs = JSON.parse(localStorage.getItem('finance_catalogs') || '[]');
    let currentCatalogId = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? 'light_mode' : 'dark_mode';

      renderCatalogs();
      if (catalogs.length > 0 && !currentCatalogId) {
        selectCatalog(catalogs[0].id);
      }
    }

    // –°–º–µ–Ω–∞ —Ç–µ–º—ã
    function toggleTheme() {
      const html = document.documentElement;
      const isDark = html.getAttribute('data-theme') === 'dark';
      
      if (isDark) {
        html.setAttribute('data-theme', 'light');
        document.getElementById('theme-icon').textContent = 'dark_mode';
        localStorage.setItem('theme', 'light');
        Toast.info('–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞');
      } else {
        html.setAttribute('data-theme', 'dark');
        document.getElementById('theme-icon').textContent = 'light_mode';
        localStorage.setItem('theme', 'dark');
        Toast.info('–¢—ë–º–Ω–∞—è —Ç–µ–º–∞');
      }
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞
    function createCatalog() {
      const name = document.getElementById('catalog-name').value.trim();
      const icon = document.getElementById('catalog-icon').value;
      const currency = document.getElementById('catalog-currency').value;
      if (!name) return Toast.error('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

      const newCatalog = {
        id: Date.now(),
        name,
        icon,
        currency,
        balance: 0,
        income: 0,
        expense: 0,
        operations: []
      };

      catalogs.push(newCatalog);
      saveCatalogs();
      renderCatalogs();
      document.getElementById('catalog-name').value = '';
      Toast.success(`üìÅ "${name}" —Å–æ–∑–¥–∞–Ω`);

      if (catalogs.length === 1) {
        selectCatalog(newCatalog.id);
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
    function renderCatalogs() {
      const listEl = document.getElementById('catalog-list');
      if (catalogs.length === 0) {
        listEl.innerHTML = '<div class="empty">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ç–∞–ª–æ–≥–æ–≤</div>';
        return;
      }

      listEl.innerHTML = '';
      catalogs.forEach(cat => {
        const btn = document.createElement('div');
        btn.className = `catalog-btn ${cat.id === currentCatalogId ? 'active' : ''}`;
        btn.onclick = () => selectCatalog(cat.id);
        btn.innerHTML = `
          <div class="icon">${cat.icon}</div>
          <div class="name">${cat.name}</div>
          <div>
            <span class="currency">${cat.currency}</span>
          </div>
          <div class="stats">–ë–∞–ª–∞–Ω—Å: ${cat.balance} ${cat.currency}</div>
          <div class="delete" onclick="deleteCatalog(event, ${cat.id})">√ó</div>
        `;
        listEl.appendChild(btn);
      });
    }

    // –í—ã–±—Ä–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥
    function selectCatalog(id) {
      currentCatalogId = id;
      const cat = catalogs.find(c => c.id === id);
      if (!cat) return;

      document.getElementById('catalog-operations').style.display = 'block';
      document.getElementById('current-catalog').textContent = cat.name;
      document.getElementById('current-icon').textContent = cat.icon;
      document.getElementById('current-currency').textContent = cat.currency;

      renderCatalogs();
      renderOperations(cat);
    }

    // –£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥
    function deleteCatalog(e, id) {
      e.stopPropagation();
      const cat = catalogs.find(c => c.id === id);
      if (!cat) return;

      if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ "${cat.name}"? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–ø–∞–¥—É—Ç.`)) return;

      catalogs = catalogs.filter(c => c.id !== id);
      saveCatalogs();
      if (currentCatalogId === id) {
        currentCatalogId = null;
        document.getElementById('catalog-operations').style.display = 'none';
      }
      renderCatalogs();
      Toast.info(`üóë "${cat.name}" —É–¥–∞–ª—ë–Ω`);
    }

    // –†–µ–Ω–¥–µ—Ä –æ–ø–µ—Ä–∞—Ü–∏–π
    function renderOperations(cat) {
      const listEl = document.getElementById('op-list');
      if (cat.operations.length === 0) {
        listEl.innerHTML = '<div style="color: var(--text-secondary); font-size: 14px; text-align: center; padding: 12px;">–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>';
        return;
      }

      listEl.innerHTML = '';
      [...cat.operations].reverse().forEach(op => {
        const div = document.createElement('div');
        div.className = `operation ${op.type}`;
        div.innerHTML = `
          <div class="note">${op.note || '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}</div>
          <div class="meta">
            <div>${op.type === 'income' ? '+' : '-'}${op.amount} ${cat.currency}</div>
            <div>${new Date(op.date).toLocaleDateString('ru-RU')}</div>
          </div>
        `;
        listEl.appendChild(div);
      });
    }

    // –î–æ—Ö–æ–¥
    function addIncomeToCatalog() {
      const amountInput = document.getElementById('op-amount');
      const noteInput = document.getElementById('op-note');
      const amount = parseFloat(amountInput.value);
      const note = noteInput.value.trim() || '–î–æ—Ö–æ–¥';

      if (isNaN(amount) || amount <= 0) return Toast.error('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');

      const cat = catalogs.find(c => c.id === currentCatalogId);
      cat.balance = (parseFloat(cat.balance) + amount).toFixed(2);
      cat.income = (parseFloat(cat.income) + amount).toFixed(2);
      cat.operations.push({
        type: 'income',
        amount: parseFloat(amount),
        note,
        date: new Date().toISOString()
      });

      saveCatalogs();
      selectCatalog(currentCatalogId);

      amountInput.value = '';
      noteInput.value = '';
      Toast.success(`+${amount} ${cat.currency} –¥–æ–±–∞–≤–ª–µ–Ω–æ`);
    }

    // –†–∞—Å—Ö–æ–¥
    function addExpenseToCatalog() {
      const amountInput = document.getElementById('op-amount');
      const noteInput = document.getElementById('op-note');
      const amount = parseFloat(amountInput.value);
      const note = noteInput.value.trim() || '–†–∞—Å—Ö–æ–¥';

      if (isNaN(amount) || amount <= 0) return Toast.error('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');

      const cat = catalogs.find(c => c.id === currentCatalogId);
      const newBalance = (parseFloat(cat.balance) - amount).toFixed(2);
      if (newBalance < 0) {
        return Toast.error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
      }

      cat.balance = newBalance;
      cat.expense = (parseFloat(cat.expense) + amount).toFixed(2);
      cat.operations.push({
        type: 'expense',
        amount: parseFloat(amount),
        note,
        date: new Date().toISOString()
      });

      saveCatalogs();
      selectCatalog(currentCatalogId);

      amountInput.value = '';
      noteInput.value = '';
      Toast.info(`-${amount} ${cat.currency} —Å–ø–∏—Å–∞–Ω–æ`);
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è (–∑–∞–≥–ª—É—à–∫–∞)
    function convertCurrency() {
      const cat = catalogs.find(c => c.id === currentCatalogId);
      if (!cat) return;

      let rate = 1;
      if (cat.currency === 'USD') rate = 92;
      else if (cat.currency === 'EUR') rate = 100;
      else if (cat.currency === 'BTC') rate = 4_000_000;

      const rub = (cat.balance * rate).toLocaleString('ru-RU');
      Toast.info(`–ë–∞–ª–∞–Ω—Å: ${cat.balance} ${cat.currency} ‚âà ${rub} RUB`, 6000);
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    function saveCatalogs() {
      const safeCatalogs = catalogs.map(cat => ({
        ...cat,
        balance: parseFloat(cat.balance) || 0,
        income: parseFloat(cat.income) || 0,
        expense: parseFloat(cat.expense) || 0
      }));
      localStorage.setItem('finance_catalogs', JSON.stringify(safeCatalogs));
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞
    document.addEventListener('DOMContentLoaded', () => {
      init();
      Toast.info('–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤');
    });
  </script>
{% endblock %}