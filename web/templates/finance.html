{% extends "base.html" %}

{% block title %}–õ–µ–æ ‚Äî –§–∏–Ω–∞–Ω—Å—ã{% endblock %}

{% block styles %}
<style>
:root {
  --bg: transparent;
  --card-bg: rgba(255, 255, 255, 0.95);
  --text: #212121;
  --text-secondary: #757575;
  --border: rgba(178, 255, 89, 0.2);
  --accent: #4CAF50;
  --accent-light: #B2FF59;
  --gold: linear-gradient(-45deg, #DAA520, #FFD700, #F4C430, #C5B358, #DAA520);
  --gold-soft: linear-gradient(-45deg, #D4A017, #E6C229, #F4C430, #D4A017);
  --radius-sm: 8px;
  --radius-md: 16px;
  --radius-lg: 24px;
  --shadow: 0 6px 20px rgba(76, 175, 80, 0.08);
  --shadow-hover: 0 12px 28px rgba(76, 175, 80, 0.16), 0 16px 40px rgba(0, 0, 0, 0.12);
  --transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

[data-theme="dark"] {
  --bg: transparent;
  --card-bg: rgba(30, 30, 30, 0.95);
  --text: #ffffff;
  --text-secondary: #b0b0b0;
  --border: rgba(178, 255, 89, 0.1);
}

body, html {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: 'Inter', sans-serif;
  color: var(--text);
  background: linear-gradient(135deg, #f0fff0, #d9f7d9, #e6ffeb);
  background-size: 400% 400%;
  animation: gradient-shift 15s ease infinite;
  min-height: 100vh;
  overflow-x: hidden;
}

[data-theme="dark"] body {
  background: linear-gradient(135deg, #0a1e0a, #0c240c, #0d2a0d);
}

@keyframes gradient-shift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 20px;
}

/* === –ï–î–ò–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø === */
.navbar {
  width: 100%;
  max-width: 1000px;
  margin: 0 auto 30px auto;
  padding: 16px 20px;
  background: var(--card-bg);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 1000;
}

.navbar button,
.navbar a {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.navbar a {
  text-decoration: none;
}

.navbar button:hover,
.navbar a:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(76, 175, 80, 0.12);
}

.navbar .logo {
  background: var(--accent);
  color: white;
  font-weight: bold;
  font-size: 18px;
  box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
}

.navbar .admin {
  background: var(--gold-soft);
  color: #1a1a1a;
  box-shadow: 0 2px 8px rgba(218, 165, 32, 0.3);
}

/* === –ö–ê–†–¢–´ === */
.card {
  background: var(--card-bg);
  border-radius: var(--radius-md);
  padding: 24px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  margin-bottom: 24px;
}

.card h3 {
  margin: 0 0 16px 0;
  font-size: 20px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 10px;
}

/* === –§–û–†–ú–´ === */
.form-group {
  margin-bottom: 18px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  color: var(--text-secondary);
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 15px;
  background: var(--card-bg);
  color: var(--text);
  box-sizing: border-box;
}

.form-control:focus {
  outline: none;
  border-color: var(--accent);
}

/* === –ö–ê–¢–ê–õ–û–ì–ò === */
.catalog-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 16px;
  margin-top: 12px;
}

.catalog-btn {
  background: rgba(76, 175, 80, 0.06);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 16px;
  text-align: left;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}

.catalog-btn:hover {
  transform: translateY(-2px);
}

.catalog-btn .icon {
  font-size: 28px;
}

.catalog-btn .name {
  font-weight: 600;
  margin: 4px 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.catalog-btn .stats {
  font-size: 13px;
  color: var(--text-secondary);
}

.catalog-btn .delete {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #f44336;
  color: white;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  opacity: 0;
}

.catalog-btn:hover .delete {
  opacity: 1;
}

/* === –û–ü–ï–†–ê–¶–ò–ò === */
.operation-list {
  max-height: 320px;
  overflow-y: auto;
  margin-top: 16px;
  border-top: 1px solid var(--border);
  padding-top: 12px;
  padding-right: 8px;
}

.operation {
  display: flex;
  justify-content: space-between;
  padding: 10px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
}

.operation:last-child {
  border-bottom: none;
}

.operation.income {
  color: #4CAF50;
}

.operation.expense {
  color: #f44336;
}

/* === –ö–ù–û–ü–ö–ò === */
.btn {
  padding: 12px 24px;
  border: none;
  border-radius: var(--radius-sm);
  color: white;
  font-weight: 500;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);
  background: #4CAF50;
  margin-bottom: 8px;
}

.btn-primary {
  background: var(--gold);
  background-size: 200% 200%;
  animation: gradient-shift-gold 3s ease infinite;
  color: white;
}

@keyframes gradient-shift-gold {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
</style>
{{ super() }}
{% endblock %}

{% block content %}
  <div class="container">
    <!-- –ï–î–ò–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
    <div class="navbar">
      <div style="display: flex; align-items: center; gap: 16px;">
        <button onclick="history.back()" title="–ù–∞–∑–∞–¥">
          <span class="material-icons">arrow_back</span>
        </button>
        <a href="/" class="logo">ü§ñ</a>
      </div>
      <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: var(--text);">–§–∏–Ω–∞–Ω—Å—ã</h2>
      <div style="display: flex; align-items: center; gap: 12px;">
        <button onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
          <span class="material-icons" id="theme-icon">dark_mode</span>
        </button>
        <a href="/cabinet" class="logo">üë§</a>
      </div>
    </div>

    <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ -->
    <div class="card">
      <h3><span class="material-icons">add</span> –ù–æ–≤—ã–π –∫–∞—Ç–∞–ª–æ–≥</h3>
      <div class="form-group">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" class="form-control" id="catalog-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: YouTube-–∫–∞–Ω–∞–ª">
      </div>
      <div class="form-group">
        <label>–ò–∫–æ–Ω–∫–∞</label>
        <select class="form-control" id="catalog-icon">
          <option value="üìÅ">üìÅ –ü–∞–ø–∫–∞</option>
          <option value="üìà">üìà –†–æ—Å—Ç</option>
          <option value="üí∞">üí∞ –î–µ–Ω—å–≥–∏</option>
          <option value="üî•">üî• –û–≥–æ–Ω—å</option>
          <option value="üéØ">üéØ –¶–µ–ª—å</option>
        </select>
      </div>
      <div class="form-group">
        <label>–í–∞–ª—é—Ç–∞</label>
        <select class="form-control" id="catalog-currency">
          <option value="RUB">üá∑üá∫ RUB (—Ä—É–±–ª—å)</option>
          <option value="USD">üá∫üá∏ USD (–¥–æ–ª–ª–∞—Ä)</option>
          <option value="EUR">üá™üá∫ EUR (–µ–≤—Ä–æ)</option>
          <option value="BTC">‚Çø BTC (–±–∏—Ç–∫–æ–∏–Ω)</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="createCatalog()">üìÅ –°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥</button>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ -->
    <div class="card">
      <h3><span class="material-icons">folder</span> –ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã</h3>
      <div class="catalog-grid" id="catalog-list">
        <div class="empty">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ç–∞–ª–æ–≥–æ–≤</div>
      </div>
    </div>

    <!-- –û–ø–µ—Ä–∞—Ü–∏–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ -->
    <div class="card" id="catalog-operations" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>
          <span id="current-icon">üìÅ</span>
          <span id="current-catalog">[–ö–∞—Ç–∞–ª–æ–≥]</span>
          <span class="currency" id="current-currency">RUB</span>
        </h3>
        <button class="btn" style="padding: 8px 16px; font-size: 14px;" onclick="convertCurrency()">üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>

      <div class="form-group">
        <label>–°—É–º–º–∞</label>
        <input type="number" class="form-control" id="op-amount" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5000">
      </div>

      <div class="form-group">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <input type="text" class="form-control" id="op-note" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö—É–ø–∏–ª –º–∏–∫—Ä–æ—Ñ–æ–Ω">
      </div>

      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="btn" onclick="addIncomeToCatalog()">‚ûï –î–æ—Ö–æ–¥</button>
        <button class="btn" onclick="addExpenseToCatalog()">‚ûñ –†–∞—Å—Ö–æ–¥</button>
      </div>

      <h4 style="margin: 20px 0 12px; color: var(--text-secondary);">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h4>
      <div class="operation-list" id="op-list"></div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    let catalogs = JSON.parse(localStorage.getItem('finance_catalogs') || '[]');
    let currentCatalogId = null;

    function toggleTheme() {
      const html = document.documentElement;
      const isDark = html.getAttribute('data-theme') === 'dark';
      const icon = document.getElementById('theme-icon');
      if (isDark) {
        html.setAttribute('data-theme', 'light');
        icon.textContent = 'dark_mode';
        localStorage.setItem('theme', 'light');
        Toast.info('–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞');
      } else {
        html.setAttribute('data-theme', 'dark');
        icon.textContent = 'light_mode';
        localStorage.setItem('theme', 'dark');
        Toast.info('–¢—ë–º–Ω–∞—è —Ç–µ–º–∞');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      if (document.getElementById('theme-icon')) {
        document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? 'light_mode' : 'dark_mode';
      }
      renderCatalogs();
    });

    function createCatalog() {
      const name = document.getElementById('catalog-name').value.trim();
      const icon = document.getElementById('catalog-icon').value;
      const currency = document.getElementById('catalog-currency').value;
      if (!name) return Toast.error('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
      const newCatalog = {
        id: Date.now(),
        name, icon, currency,
        balance: 0, income: 0, expense: 0, operations: []
      };
      catalogs.push(newCatalog);
      saveCatalogs();
      renderCatalogs();
      document.getElementById('catalog-name').value = '';
      Toast.success(`üìÅ "${name}" —Å–æ–∑–¥–∞–Ω`);
    }

    function renderCatalogs() {
      const listEl = document.getElementById('catalog-list');
      if (catalogs.length === 0) {
        listEl.innerHTML = '<div class="empty">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ç–∞–ª–æ–≥–æ–≤</div>';
        return;
      }
      listEl.innerHTML = '';
      catalogs.forEach(cat => {
        const btn = document.createElement('div');
        btn.className = `catalog-btn ${cat.id === currentCatalogId ? 'active' : ''}`;
        btn.onclick = () => selectCatalog(cat.id);
        btn.innerHTML = `
          <div class="icon">${cat.icon}</div>
          <div class="name">${cat.name}</div>
          <div class="stats">–ë–∞–ª–∞–Ω—Å: ${cat.balance} ${cat.currency}</div>
          <div class="delete" onclick="deleteCatalog(event, ${cat.id})">√ó</div>
        `;
        listEl.appendChild(btn);
      });
    }

    function selectCatalog(id) {
      currentCatalogId = id;
      const cat = catalogs.find(c => c.id === id);
      document.getElementById('catalog-operations').style.display = 'block';
      document.getElementById('current-catalog').textContent = cat.name;
      document.getElementById('current-icon').textContent = cat.icon;
      document.getElementById('current-currency').textContent = cat.currency;
      renderCatalogs();
      renderOperations(cat);
    }

    function deleteCatalog(e, id) {
      e.stopPropagation();
      const cat = catalogs.find(c => c.id === id);
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å "${cat.name}"?`)) return;
      catalogs = catalogs.filter(c => c.id !== id);
      saveCatalogs();
      if (currentCatalogId === id) {
        currentCatalogId = null;
        document.getElementById('catalog-operations').style.display = 'none';
      }
      renderCatalogs();
      Toast.info(`üóë "${cat.name}" —É–¥–∞–ª—ë–Ω`);
    }

    function renderOperations(cat) {
      const listEl = document.getElementById('op-list');
      if (cat.operations.length === 0) {
        listEl.innerHTML = '<div style="color: var(--text-secondary); font-size: 14px; text-align: center; padding: 12px;">–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>';
        return;
      }
      listEl.innerHTML = '';
      [...cat.operations].reverse().forEach(op => {
        const div = document.createElement('div');
        div.className = `operation ${op.type}`;
        div.innerHTML = `
          <div>${op.note || '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}</div>
          <div>${op.type === 'income' ? '+' : '-'}${op.amount} ${cat.currency}</div>
        `;
        listEl.appendChild(div);
      });
    }

    function addIncomeToCatalog() {
      const amount = parseFloat(document.getElementById('op-amount').value);
      const note = document.getElementById('op-note').value.trim() || '–î–æ—Ö–æ–¥';
      if (isNaN(amount) || amount <= 0) return Toast.error('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');
      const cat = catalogs.find(c => c.id === currentCatalogId);
      cat.balance = (parseFloat(cat.balance) + amount).toFixed(2);
      cat.income = (parseFloat(cat.income) + amount).toFixed(2);
      cat.operations.push({ type: 'income', amount, note, date: new Date().toISOString() });
      saveCatalogs();
      selectCatalog(currentCatalogId);
      document.getElementById('op-amount').value = '';
      document.getElementById('op-note').value = '';
      Toast.success(`+${amount} ${cat.currency} –¥–æ–±–∞–≤–ª–µ–Ω–æ`);
    }

    function addExpenseToCatalog() {
      const amount = parseFloat(document.getElementById('op-amount').value);
      const note = document.getElementById('op-note').value.trim() || '–†–∞—Å—Ö–æ–¥';
      if (isNaN(amount) || amount <= 0) {
        Toast.error('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');
        return;
      }
      const cat = catalogs.find(c => c.id === currentCatalogId);
      const newBalance = (parseFloat(cat.balance) - amount).toFixed(2);
      if (newBalance < 0) {
        Toast.error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
        return;
      }
      cat.balance = newBalance;
      cat.expense = (parseFloat(cat.expense) + amount).toFixed(2);
      cat.operations.push({ type: 'expense', amount, note, date: new Date().toISOString() });
      saveCatalogs();
      selectCatalog(currentCatalogId);
      document.getElementById('op-amount').value = '';
      document.getElementById('op-note').value = '';
      Toast.info(`-${amount} ${cat.currency} —Å–ø–∏—Å–∞–Ω–æ`);
    }

    function convertCurrency() {
      const cat = catalogs.find(c => c.id === currentCatalogId);
      let rate = 1;
      if (cat.currency === 'USD') rate = 92;
      else if (cat.currency === 'EUR') rate = 100;
      else if (cat.currency === 'BTC') rate = 4_000_000;
      const rub = (cat.balance * rate).toLocaleString('ru-RU');
      Toast.info(`–ë–∞–ª–∞–Ω—Å: ${cat.balance} ${cat.currency} ‚âà ${rub} RUB`, 6000);
    }

    function saveCatalogs() {
      const safe = catalogs.map(c => ({
        ...c,
        balance: parseFloat(c.balance) || 0,
        income: parseFloat(c.income) || 0,
        expense: parseFloat(c.expense) || 0
      }));
      localStorage.setItem('finance_catalogs', JSON.stringify(safe));
    }
  </script>
{% endblock %}