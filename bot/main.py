# bot/main.py

import os
import asyncio
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton, MenuButtonWebApp, WebAppInfo
from telegram.ext import Application, ContextTypes, CommandHandler, CallbackQueryHandler

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ database.py
from database import create_db_pool, init_db, add_or_update_user, delete_inactive_users
from features.menu import setup as setup_menu

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
db_pool = None

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—Å–ª–µ /start
def get_start_keyboard():
    keyboard = [
        [InlineKeyboardButton("üìå –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="menu_main")],
        [InlineKeyboardButton("üåê Mini App", url="https://web-production-b74ea.up.railway.app")]
    ]
    return InlineKeyboardMarkup(keyboard)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await add_or_update_user(db_pool, user)

    await update.message.reply_html(
        text=f"üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.first_name}!</b>\n\n"
             f"–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:",
        reply_markup=get_start_keyboard()
    )

# –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞: —É–¥–∞–ª—è–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
async def cleanup_task(application: Application):
    while True:
        try:
            await asyncio.sleep(24 * 3600)  # –ö–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
            await delete_inactive_users(db_pool, days=90)
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –≤ cleanup: {e}")

# –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
async def on_startup(application: Application):
    global db_pool
    print("üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î...")
    db_pool = await create_db_pool()
    await init_db(db_pool)
    print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
    application.create_task(cleanup_task(application))

async def post_init(application: Application):
    await application.bot.set_chat_menu_button(
        menu_button=MenuButtonWebApp(
            text="üåê –ü–∞–Ω–µ–ª—å",
            web_app=WebAppInfo(url="https://web-production-b74ea.up.railway.app")
        )
    )
    print("üöÄ –ú–µ–Ω—é (‚â°) —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")

def main():
    # –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    app = Application.builder().token(os.getenv("BOT_TOKEN")).post_init(post_init).build()

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–µ–Ω—é
    setup_menu(app)

    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    app.add_handler(CommandHandler("start", start))

    # –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ë–î –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    app.add_post_init(on_startup)

    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    app.run_polling()

if __name__ == "__main__":
    main()
